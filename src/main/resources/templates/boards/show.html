<!DOCTYPE html>
    <html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>글 상세보기</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f7f9fc;
                margin: 40px;
                color: #333;
            }

            table {
                width: 80%;
                margin: 0 auto;
                border-collapse: collapse;
                background-color: #fff;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                border-radius: 8px;
                overflow: hidden;
            }

            colgroup col {
                text-align: center;
            }

            th, td {
                padding: 16px;
                border-bottom: 1px solid #e0e0e0;
            }

            th {
                background-color: #f1f3f5;
                text-align: left;
                font-weight: 600;
                color: #555;
            }

            td[colspan="3"], td[colspan="2"] {
                background-color: #fafafa;
            }

            tr:last-child td {
                border-bottom: none;
            }

            h1 {
                text-align: center;
                color: #2c3e50;
                margin-bottom: 20px;
            }

            .table-footer {
                width: 80%;
                margin: 20px auto 0 auto; /* 위는 10px, 좌우는 auto, 아래는 0 */
                text-align: right;
            }
        </style>
    </head>
    <body>
        <h1>글 상세보기</h1>
        <form th:action="@{/boards/delete}" method="post">
            <input type="hidden" th:value="${board.idx}" name="idx">
            <table>
                <colgroup>
                    <col style="width:20%;" />
                    <col style="width:40%;" />
                    <col style="width:20%;" />
                    <col style="width:20%;" />
                </colgroup>
                <tbody>
                <tr>
                    <th scope="row">제목</th>
                    <td colspan="3" th:text="${board.title}">제목 내용</td>
                </tr>
                <tr>
                    <th scope="row">작성자</th>
                    <td th:text="${board.id}">작성자명</td>
                    <th scope="row">조회수</th>
                    <td th:text="${board.viewCount}">조회</td>
                </tr>
                <tr>
                    <th scope="row">작성일</th>
                    <td th:text="${#temporals.format(board.createDate, 'yy-MM-dd HH:mm:ss')}">작성일</td>
                    <th scope="row">수정일</th>
                    <td><span th:if="${board.modifieDate != null}" th:text="${#temporals.format(board.modifieDate, 'yy-MM-dd HH:mm:ss')}">수정일</span></td>
                </tr>
                <tr>
                    <th scope="row">내용</th>
                    <td colspan="3" th:text="${board.content}">여기에 본문 내용이 들어갑니다.</td>
                </tr>
                </tbody>
            </table>
            <div class="table-footer">
                <a class="btn btn-success" th:href="@{/boards/edit/{boardIdx}(boardIdx=${board.idx})}">글 수정</a>
                <button type="submit" class="btn btn-success">글 삭제</button>
                <a class="btn btn-success" href="/">글 목록</a>
            </div>
        </form>

        <!-- 댓글 작성 폼-->
        <div>
            <input type="hidden" th:value="${board.idx}"  id="commentBoardIdx" name="boardIdx">
            <h3><label>댓글 작성</label></h3>
            <div class="mb-3">
                <label for="commentId" class="form-label">작성자</label>
                <input type="text" class="form-control" id="commentId">
            </div>
            <div class="mb-3">
                <label for="commentContent" class="form-label">내용</label>
                <textarea class="form-control" id="commentContent" rows="3"></textarea>
            </div>
            <button type="button" class="btn btn-success" id="commentCreate">댓글 등록</button>
        </div>

        <!--댓글 리스트 -->
        <div class="mt-5">
            <h3 class="mb-3">댓글 목록</h3>
            <div th:each="comment : ${comments}" class="p-3 mb-3 border rounded bg-light shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <strong class="text-success me-3">
                            <i class="bi bi-person-fill"></i> [[${comment.id}]]
                        </strong>
                        <small class="text-muted me-2" th:if="${comment.createDate != null}"
                               th:text="|작성일: ${#temporals.format(comment.createDate, 'yy-MM-dd HH:mm')}|">작성일</small>
                        <small class="text-muted" th:if="${comment.modifieDate != null}"
                               th:text="|수정일: ${#temporals.format(comment.modifieDate, 'yy-MM-dd HH:mm')}|">수정일</small>
                    </div>
                </div>
                <div class="ps-2 mb-2">
<!--                    <p class="mb-1" th:text="${comment.content}">댓글 내용</p>-->
                    <p class="mb-1 comment-content" data-idx="[[${comment.idx}]]" th:text="${comment.content}">댓글 내용</p>
                </div>
                <!-- 댓글 수정/삭제 버튼 영역 -->
                <div class="text-end">
<!--                    <button type="button" class="btn btn-outline-primary btn-sm me-2" id="commentEdit" th:attr="data-comment-id=${comment.idx}">수정</button>-->
<!--                    <button type="button" class="btn btn-outline-danger btn-sm" th:attr="data-comment-id=${comment.idx}">삭제</button>-->
                    <button type="button" class="btn btn-outline-primary btn-sm me-2 comment-edit" data-comment-idx="[[${comment.idx}]]">수정</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="commentDelete">삭제</button>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
        {
            // 댓글 등록 버튼 변수화
            const commentCreateBtn = document.querySelector("#commentCreate");
            // 댓글 클릭 이벤트 감지
            commentCreateBtn.addEventListener("click", function() {
                console.log("버튼 클릭");

                // 새 댓글 객체 생성
                const comment = {
                    id: document.querySelector("#commentId").value,
                    content: document.querySelector("#commentContent").value,
                    board_idx: document.querySelector("#commentBoardIdx").value
                };

                // 댓글 객체 출력
                console.log(comment);

                // fetch() - 비동기 통신을 위한 API
                const url = "/boards/" + comment.board_idx + "/comments";
                fetch(url, {
                    method: "post",                // post 요청
                    body: JSON.stringify(comment), // comment JS 객체를 JSON으로 변경하여 보냄
                    headers: {
                        "Content-Type": "application/json" // body에 실어서 보내는 내용물의 타입이 json이라고 헤더에 보냄
                    }
                }).then(response => {
                    // http 응답 코드에 따른 메세지 출력
                    const msg = (response.ok) ? "댓글 등록" : "댓글 실패";
                    alert('댓글등록');
                    // 현재 페이지 새로고침
                    window.location.reload();
                });
            });
        }

        {
            // 댓글 수정 버튼 변수화
            const commentEdits = document.querySelectorAll(".comment-edit");

            // 수정 버튼 이벤트 처리
            commentEdits.forEach(function(button) {
                button.addEventListener("click", function() {
                    const commentIdx = this.getAttribute("data-comment-idx");
                    const target = document.querySelector(`[data-idx='${commentIdx}']`);

                    if (this.textContent.trim() === "수정") {
                        this.textContent = "수정완료";

                        // <p> -> <textarea>
                        const textarea = document.createElement("textarea");
                        textarea.className = "form-control comment-content";
                        textarea.value = target.textContent.trim();
                        textarea.setAttribute("data-idx", commentIdx);

                        target.replaceWith(textarea);

                    } else {
                        this.textContent = "수정";

                        // 수정된 내용 추출
                        const newContent = target.value.trim();

                        // <textarea> -> <p>
                        const newP = document.createElement("p");
                        newP.className = "mb-1 comment-content";
                        newP.setAttribute("data-idx", commentIdx);
                        newP.textContent = newContent;

                        target.replaceWith(newP);

                        // PATCH 요청
                        const boardIdx = document.querySelector("#commentBoardIdx").value;
                        const url = `/boards/${boardIdx}/comments/${commentIdx}`;
                        const data = { content: newContent };

                        fetch(url, {
                            method: "PATCH",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => {
                            if (response.ok) {
                                alert("댓글이 수정되었습니다.");
                            } else {
                                alert("댓글 수정 실패");
                            }
                        })
                        .catch(error => {
                            console.error("오류 발생:", error);
                            alert("서버 오류로 댓글 수정 실패");
                        });
                    }
                });
            });

        }
        </script>
    </body>
</html>



